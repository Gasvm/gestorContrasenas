// Cargar categorías al cargar la página
document.addEventListener('DOMContentLoaded', () => {
    loadCategoriesIntoSelect();
});

// Cargar categorías en el select
function loadCategoriesIntoSelect() {
    fetch('http://localhost:3000/categories')
        .then(res => res.json())
        .then(categories => {
            let select = document.getElementById('categorySelect');
            
            categories.forEach(category => {
                let option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error al cargar categorías:', error);
            Swal.fire({
                title: 'Error',
                text: 'No se pudieron cargar las categorías',
                icon: 'error'
            });
        });
}

// Event listener del formulario
let form = document.getElementById('siteForm');

form.addEventListener('submit', (event) => {
    event.preventDefault(); // Evita que el formulario recargue la página
    
    // Obtener valores del formulario
    let categoryId = document.getElementById('categorySelect').value;
    let name = document.getElementById('siteName').value.trim();
    let url = document.getElementById('siteUrl').value.trim();
    let user = document.getElementById('siteUser').value.trim();
    let password = document.getElementById('sitePassword').value;
    
    // Validar que los campos obligatorios no estén vacíos
    if (!categoryId || !name || !user || !password) {
        Swal.fire({
            title: 'Error',
            text: 'Por favor completa todos los campos obligatorios',
            icon: 'error'
        });
        return;
    }
    
    // Crear objeto con los datos
    let siteData = {
        categoryId: parseInt(categoryId),
        name: name,
        url: url || '',
        user: user,
        password: password
    };
    
    // Enviar a la API
    createSite(siteData);
});

// Crear site en la API
function createSite(siteData) {
    fetch('http://localhost:3000/sites', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(siteData)
    })
    .then(res => {
        if (!res.ok) throw new Error('Error al crear site');
        return res.json();
    })
    .then(data => {
        console.log('Site creado:', data);
        
        Swal.fire({
            title: '¡Creado!',
            text: 'El site ha sido creado correctamente',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
        });
        
        // Redirigir a index después de 2 segundos
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 2000);
    })
    .catch(error => {
        console.error('Error al crear site:', error);
        
        Swal.fire({
            title: 'Error',
            text: 'No se pudo crear el site',
            icon: 'error'
        });
    });
}

// Botón cancelar
let btnCancel = document.getElementById('btnCancel');

btnCancel.addEventListener('click', () => {
    window.location.href = 'index.html';
});